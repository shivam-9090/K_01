# CI/CD Pipeline Documentation

## Overview

This project implements a comprehensive CI/CD pipeline using **GitHub Actions** for automated testing, building, and quality assurance.

## Pipeline Architecture

```
Developer Push
    â†“
GitHub Actions Triggered
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        CI Pipeline (Parallel)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Lint     2. Test   3. Security  â”‚
â”‚  - ESLint    - Unit    - npm audit  â”‚
â”‚  - TypeCheck - E2E     - Secret scanâ”‚
â”‚  - Build     - Cover   - Trivy      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
        All Pass? â”€â”€Noâ”€â”€> âŒ Fail (Block PR)
              â”‚
             Yes
              â†“
         âœ… Success
              â†“
    Docker Build & Push
              â†“
    Artifact Stored
              â†“
    (Ready for Manual Deploy)
```

## Workflows

### 1. **CI Pipeline** (`.github/workflows/ci.yml`)

**Triggers**: Push to `master`, `main`, `develop` or PR

**Jobs**:

#### ğŸ” Lint Job

- âœ… Runs ESLint with auto-fix
- âœ… TypeScript type checking
- âœ… Build validation

#### ğŸ§ª Test Job

- âœ… Spins up PostgreSQL & Redis containers
- âœ… Runs Prisma migrations
- âœ… Unit tests with coverage
- âœ… E2E tests in band (sequential)
- âœ… Uploads coverage to Codecov

#### ğŸ”’ Security Job

- âœ… npm audit for vulnerabilities
- âœ… TruffleHog secret scanning
- âœ… Checks for exposed credentials

#### ğŸ³ Build Job

- âœ… Builds Docker image
- âœ… Tests Docker container startup
- âœ… Saves image as artifact (7-day retention)
- âœ… Tagged with commit SHA

#### ğŸ“Š Summary Job

- âœ… Aggregates all job results
- âœ… Creates GitHub step summary
- âœ… Fails pipeline if any job fails

**Environment Variables Required**:

- `DATABASE_URL`
- `JWT_SECRET`
- `TWOFA_ENCRYPTION_KEY`
- `REDIS_HOST`, `REDIS_PORT`

---

### 2. **Docker Build & Push** (`.github/workflows/docker-build.yml`)

**Triggers**:

- Push to `master` or `main`
- Git tags (`v*`)
- Manual trigger

**Jobs**:

#### ğŸ‹ Build and Push

- âœ… Multi-platform build (amd64, arm64)
- âœ… Pushes to GitHub Container Registry (ghcr.io)
- âœ… Tags: `latest`, `sha-<commit>`, version tags
- âœ… Uses layer caching for fast builds
- âœ… Generates SBOM (Software Bill of Materials)
- âœ… Scans image with Trivy for vulnerabilities
- âœ… Uploads scan results to GitHub Security

**Image Tags**:

- `ghcr.io/<owner>/<repo>/backend:latest`
- `ghcr.io/<owner>/<repo>/backend:master-abc1234`
- `ghcr.io/<owner>/<repo>/backend:v1.0.0`

---

### 3. **PR Checks** (`.github/workflows/pr-checks.yml`)

**Triggers**: PR opened, synchronized, or reopened

**Jobs**:

#### âœï¸ PR Validation

- âœ… Validates PR title follows conventional commits:
  - `feat:`, `fix:`, `docs:`, `refactor:`, etc.
- âœ… Checks branch naming:
  - `feature/*`, `bugfix/*`, `hotfix/*`, `release/*`
- âœ… Detects large files (>5MB)
- âœ… Checks for merge conflict markers

#### ğŸ“ Size Label

- âœ… Auto-labels PR by size:
  - `size/xs` - <10 lines
  - `size/s` - <100 lines
  - `size/m` - <500 lines
  - `size/l` - <1000 lines
  - `size/xl` - >1000 lines
- âœ… Warns on extra-large PRs

---

### 4. **Scheduled Tests** (`.github/workflows/cron-tests.yml`)

**Triggers**:

- Daily at 2 AM UTC
- Manual trigger

**Jobs**:

#### ğŸŒ™ Nightly Tests

- âœ… Runs full test suite with coverage
- âœ… Tests against PostgreSQL & Redis
- âœ… Uploads coverage to Codecov
- âœ… Creates summary on failure

#### ğŸ” Dependency Audit

- âœ… Scans for vulnerable dependencies
- âœ… Reports critical and high vulnerabilities
- âœ… Fails if vulnerabilities detected
- âœ… Daily security monitoring

---

## Required Secrets

Configure these in GitHub Settings â†’ Secrets:

| Secret                     | Description              | Required For     |
| -------------------------- | ------------------------ | ---------------- |
| `GITHUB_TOKEN`             | Auto-generated by GitHub | All workflows    |
| `CODECOV_TOKEN` (optional) | Codecov integration      | Coverage reports |

No additional secrets needed for testing workflows.

---

## Local Testing

### Run tests locally (same as CI):

```bash
cd backend

# Install dependencies
npm ci

# Run linter
npm run lint

# Run type check
npm run build

# Run tests
npm test

# Run tests with coverage
npm test -- --coverage

# Run e2e tests only
npm test -- --testRegex='.e2e-spec.ts$'
```

### Test with Docker:

```bash
cd backend

# Build image
docker build -t auth-backend:test .

# Test container
docker run -d --name test-container \
  -e DATABASE_URL=postgresql://user:pass@host:5432/db \
  -e JWT_SECRET=test-secret \
  auth-backend:test

# Check logs
docker logs test-container

# Cleanup
docker stop test-container
docker rm test-container
```

---

## CI/CD Best Practices Implemented

### âœ… Fail Fast

- Linting runs first (fastest)
- Tests run in parallel where possible
- Pipeline stops on first failure

### âœ… Build Once, Deploy Many

- Docker image built once with SHA tag
- Same image artifact used across environments
- No rebuilding in production

### âœ… Test Isolation

- Each test job uses fresh database
- Services in containers (PostgreSQL, Redis)
- No shared state between tests

### âœ… Security First

- Automated vulnerability scanning
- Secret detection
- Image scanning with Trivy
- Regular dependency audits

### âœ… Fast Feedback

- Parallel job execution
- Layer caching for Docker builds
- npm dependency caching
- Average pipeline time: 3-5 minutes

### âœ… Reproducibility

- Same tests run locally and in CI
- Pinned Node.js version (20)
- Locked dependencies (`npm ci`)
- Containerized services

---

## Pipeline Status Badges

Add to your README.md:

```markdown
![CI](https://github.com/<owner>/<repo>/workflows/CI%20-%20Build%20and%20Test/badge.svg)
![Docker Build](https://github.com/<owner>/<repo>/workflows/Docker%20Build%20and%20Push/badge.svg)
[![codecov](https://codecov.io/gh/<owner>/<repo>/branch/master/graph/badge.svg)](https://codecov.io/gh/<owner>/<repo>)
```

---

## Troubleshooting

### CI tests fail but pass locally

**Issue**: Environment differences

**Solutions**:

- Check Node.js version (CI uses v20)
- Ensure database is clean before tests
- Check environment variables
- Run `npm ci` instead of `npm install`

### Docker build fails

**Issue**: Missing files or dependencies

**Solutions**:

- Check `.dockerignore`
- Verify Dockerfile syntax
- Test build locally: `docker build -t test .`
- Check build logs for specific errors

### Tests timeout

**Issue**: Database/Redis not ready

**Solutions**:

- Increase health check intervals
- Add wait scripts before tests
- Check service configurations
- Use `--runInBand` for e2e tests

### Secrets detected

**Issue**: TruffleHog found potential secrets

**Solutions**:

- Review detected files
- Move secrets to `.env.example`
- Add false positives to `.trufflehog-ignore`
- Rotate exposed secrets immediately

---

## Pipeline Metrics

**Current Performance**:

- Lint: ~1 minute
- Test: ~3 minutes
- Security: ~2 minutes
- Build: ~2 minutes
- **Total**: ~5-6 minutes (parallel execution)

**Coverage Target**: >80%

**Test Count**: 100+ tests (unit + e2e)

---

## Future Enhancements

### Phase 2 (Deployment)

- [ ] CD to staging environment
- [ ] CD to production with approval
- [ ] Blue-green deployment strategy
- [ ] Automated rollback on failure

### Phase 3 (Advanced)

- [ ] Performance testing
- [ ] Load testing with k6
- [ ] Visual regression testing
- [ ] Automated changelog generation
- [ ] Release notes automation

---

## Related Documentation

- [MONITORING.md](../backend/MONITORING.md) - Monitoring setup
- [SECURITY.md](../backend/SECURITY.md) - Security implementation
- [README.md](../backend/README.md) - Project overview

---

## Getting Help

**Pipeline failing?**

1. Check the GitHub Actions tab
2. Review the failed job logs
3. Check step summary for quick diagnostics
4. Run tests locally to reproduce

**Need to skip CI?**

- Add `[skip ci]` to commit message
- Only use for documentation changes
- Not recommended for code changes

---

**Status**: âœ… CI Pipeline Implemented & Tested

**Last Updated**: 2025-12-24
