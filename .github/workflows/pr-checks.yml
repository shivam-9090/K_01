name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert

      - name: Check branch naming
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          if [[ ! $BRANCH_NAME =~ ^(feature|bugfix|hotfix|release)/.+ ]]; then
            echo "❌ Branch name must follow: feature/*, bugfix/*, hotfix/*, or release/*"
            exit 1
          fi
          echo "✅ Branch naming is valid"

      - name: Check for large files
        run: |
          large_files=$(find . -type f -size +5M -not -path "*/node_modules/*" -not -path "*/.git/*")
          if [ -n "$large_files" ]; then
            echo "❌ Large files detected (>5MB):"
            echo "$large_files"
            exit 1
          fi
          echo "✅ No large files detected"

      - name: Check for merge conflicts
        run: |
          if git diff --check; then
            echo "✅ No merge conflict markers found"
          else
            echo "❌ Merge conflict markers detected"
            exit 1
          fi

  size-label:
    name: Label PR by Size
    runs-on: ubuntu-latest

    steps:
      - uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: "size/xs"
          xs_max_size: "10"
          s_label: "size/s"
          s_max_size: "100"
          m_label: "size/m"
          m_max_size: "500"
          l_label: "size/l"
          l_max_size: "1000"
          xl_label: "size/xl"
          message_if_xl: "This PR is very large. Consider breaking it into smaller PRs."
